<html>
<head>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

    <!-- following for testing only -->
   <script src="testConfigBase.js"></script>
    <script src="src/cloverCloud-min.js"></script>

  <link rel="stylesheet" type="text/css" href="appStyle.css">
</head>

<body onbeforeunload="clover.close()">

<p>
  This is an example of the Clover High Level Cloud API. It relies on the device to be running the
  Cloud Pay Display app. It uses the device serial id to identify the device. It makes a connection to
  a device, and prints a receipt for a payment made in an earlier operation. The result of the transaction is displayed
  below.
</p>

<!-- this is a place to talk about what is happening while the example is being run -->
<div id="uiFeedback" style="height: 400px;">
</div>

<script>

  // Create the Clover object to communicate with the device
  var config = copyConfig();
  var clover = new Clover(config);

  // Start communication
  // Pass the function that should be called when the device is ready.
  clover.initDeviceConnection(printAReceipt);

  // This will be called when the device is ready
  function printAReceipt(error) {
    if (error) {
      var resultDisplay = "";
      resultDisplay += "<pre>" + JSON.stringify(error, null, 4) + "</pre>";
      document.getElementById("uiFeedback").innerHTML = resultDisplay;
    } else {
      var paymentId = prompt("Please enter the payment id", "SZYDNRB1DGXT6");
      if (paymentId) {
        var orderId = prompt("Please enter the order id", "M5MMQGBCMZD72");
        if (orderId) {
          var printRequest = {
            "paymentId": paymentId,
            "orderId":  orderId
          }

          // Listen for UI_STATE messages
          clover.device.on(LanMethod.UI_STATE, onUiState);

          // Call the device to issue the refund
          clover.printReceipt(printRequest, resultCallback);

        } else {
          resultDisplay = "User canceled test";
          document.getElementById("uiFeedback").innerHTML = resultDisplay;
        }
      } else {
        resultDisplay = "User canceled test";
        document.getElementById("uiFeedback").innerHTML = resultDisplay;
      }
    }
  }

  function onUiState(message) {
    var payload = JSON.parse(message.payload);
    if(payload.uiState == "RECEIPT_OPTIONS" && payload.uiDirection == "ENTER") {
      onReceiptOptions(payload);
    }
  }

  function onReceiptOptions(payload) {
    var ui_display = "<p>"+payload.uiText+"</p>";
    for(var i=0; i<payload.inputOptions.length; i++){
      ui_display += "<button id='btn" + i +
          "' onclick='clover.device.sendKeyPress(\"" + payload.inputOptions[i].keyPress + "\")'>"+payload.inputOptions[i].description+"</button>";
    }
    document.getElementById("uiFeedback").innerHTML = ui_display;
  }

  /**
   *
   * @param error - adheres to the node.js style of error first callbacks.
   * @param resultData - the result of the operation
   * @see http://fredkschott.com/post/2014/03/understanding-error-first-callbacks-in-node-js/
   */
  function resultCallback(error, resultData) {
    // do something with this.
    var resultDisplay = "";
    if (error)resultDisplay += "<pre>" + JSON.stringify(error, null, 4) + "</pre>";
    resultDisplay += "<pre>" + JSON.stringify(resultData, null, 4) + "</pre>";
    document.getElementById("uiFeedback").innerHTML = resultDisplay;
  }
</script>


</body>
</html>
